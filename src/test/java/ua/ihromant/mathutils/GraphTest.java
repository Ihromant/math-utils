package ua.ihromant.mathutils;

import org.junit.jupiter.api.Test;
import tools.jackson.databind.ObjectMapper;
import ua.ihromant.jnauty.GraphData;
import ua.ihromant.jnauty.JNauty;
import ua.ihromant.mathutils.util.FixBS;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.IntStream;

import static org.junit.jupiter.api.Assertions.assertEquals;

public class GraphTest {
    private static final String INCIDENCE = """
            1111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            1000000000000000111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            1000000000000000000000000000000111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            1000000000000000000000000000000000000000000000111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0100000000000000100000000000000100000000000000100000000000000111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0010000000000000010000000000000010000000000000010000000000000100000000000111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0001000000000000001000000000000001000000000000001000000000000100000000000000000000001111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0000100000000000000100000000000000100000000000000100000000000100000000000000000000000000000000011111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0000010000000000000010000000000001000000000000000010000000000010000000000100000000000000000000010000000000111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0100000000000000000001000000000000010000000000000001000000000000000000000010000000001000000000001000000000100000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000
            0000001000000000001000000000000000001000000000000000100000000001000000000001000000000000000000000100000000100000000000000001111111100000000000000000000000000000000000000000000000000000000000000000000000000000
            0000000100000000000000100000000000000100000000100000000000000000000000000000100000000100000000000010000000100000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000
            0000001000000000000010000000000000000010000000000000010000000000100000000000010000000010000000000010000000000000000100000000000000000000000111111100000000000000000000000000000000000000000000000000000000000000
            0000000100000000000001000000000000000001000000000000001000000000010000000100000000000001000000000001000000000000000000000001000000000000000100000011111100000000000000000000000000000000000000000000000000000000
            0000000010000000000000010000000000000000100000000000000100000000001000000000001000000000100000000100000000010000000010000000000000010000000100000000000011110000000000000000000000000000000000000000000000000000
            0000000001000000000000001000000000000000010000000000000010000000000100000010000000000000010000000000100000001000000000000000100000001000000100000000000000001111000000000000000000000000000000000000000000000000
            0000000000100000000001000000000000000000001000000100000000000010000000000000000100000010000000000000000000000000000000000000010000001000000000000000000010000000111111000000000000000000000000000000000000000000
            0000000001000000000000000100000000000100000000001000000000000000100000000000000010000000000000001000000000000100000000000000001000000000000000000010000001000000100000111100000000000000000000000000000000000000
            0000000000010000000000010000000100000000000000000010000000000000000000000001000000000001000000000000010000000000000001000000000000000100000010000000000000001000100000000011110000000000000000000000000000000000
            0000001000000000000000000010000010000000000000000000000001000000010000000000000000000100000000000000001000010000000000100000000000000000000000000000000000000100100000000000001111100000000000000000000000000000
            0000000000001000000000001000000000100000000000000010000000000000001000000000000001000000001000000000000000000000000000010000001000000010000001000001000000000000010000000000001000011000000000000000000000000000
            0000000010000000000000000001000000000100000000010000000000000000000010000000000000000000010000000000000100000010000001000000000100000000000000100000100000000000001000000000000100010100000000000000000000000000
            0000000001000000000100000000000000000000000100000000100000000000000001000000000100000001000000000000000000000001000000001000000000000001000000010000000000100000000000000000000010010011000000000000000000000000
            0010000000000000000000010000000000010000000000000000000000100000100000000000000000000000000100000000001000000000100000000000000010000000100000000000010000000010000100000000000000010000110000000000000000000000
            0100000000000000000000000000100000000000000010000000000010000000000000000000100000000000000010000100000000000010000000000000000000000000000010000001000000000000000010100000000010000000101100000000000000000000
            0000000000000100001000000000000000000000100000000000000000010000000000100010000000000000000000010000000000000000000000000000000000000010000000100010000000000000000100000010000001000010001010000000000000000000
            0000000000000010000000000000010001000000000000000000000100000001000000000000000000100000000000000010000000000000000000001000000000000000000000000000010000000100010000010001000000000100001001000000000000000000
            0000000000000001000000000000001000000000010000100000000000000000000000000100000000001000000000000000000010000000000000000000000010000000000000010000000010000000000000001000100100001000001000100000000000000000
            0001000000000000000000100000000000000010000000000000000000001001000000000000000000010000000000000001000000010000000001000000000000000000000000000000000000000010000001100000000000001010000000011000000000000000
            0000010000000000100000000000000000000000000001000000001000000000000000000000010000001000000000000000000001000000000000000000001000001000000000000000000000100000000000000010000000100100100000010100000000000000
            0000100000000000000000000000100000001000000000000000000100000000000000010100000000000000000001000000000000000000000000000100000000000001000001000000000000001000001000000100000001000000010000010000000000000000
            0000000000000100010000000000000000000000010000000001000000000000000000001000000000000000000000100010000000000000100000000000000001000000000000000000100001000000000010000000011000000001000000010000000000000000
            0000000000000001000100000000000000000000000001000000010000000000000000010000001000000100000000000000000000000000010000010000100000000000000000000000100000000000000100100001000000000000000000000011000000000000
            0010000000000000000000000000010000000001000000000000000000001010000000000000000000000000000000100000100000000000000010000000000100000000010001000000000000000000000000001010000010000000000000000010100000000000
            0000000100000000010000000000000000000000000010000000100000000000000010000000000000000000100000001000000000000000001000000000000000000000000000001000000000000010010000000000100001000000000000000110010000000000
            0000100000000000000010000000000000010000000000000000000000010000000100000001000000000000001000000000000000000000000000000000000000000000001000000000001000100000000010010000000100000000000000001010001000000000
            0000000100000000000000000010000001000000000000000000000000100000000100000000000010000000000000000000000001000000000010000000000000100000000010000000000000000000001000000000000000001001000010000001000100000000
            0000000000000010000000000001000100000000000000000000010000000000000000000000100000000000000001000000100000000000100000100000001000000000000000000000001010000000000000000000000000000010000000000000010110000000
            0000000000100000000010000000000000000000000100100000000000000000000000000000000000010000100000000000010000000000000000000010100000000000000000000010000000000000000000000000001000000100010100000000100100000000
            0000000000001000000000000000001000000001000000001000000000000000000000001000001000000000000000010000000000000000000001000000010000000001000000001000000000000100000000000000000000000000100000000000001101000000
            0000000000000010000000000100000000100000000000000000001000000000000000001000000100000000010000000000000000000000010010000000000010000100000000000100000000000000000000000000000001000000000100001000000000100000
            0000000000010000000000000000001000000010000000010000000000000000001000000000000000000000000001000000001000000100000000001000100000000000010000000000000100000000000010000000000000000000000010000100000000100000
            0000000000000100000100000000000000000001000000000000000001000000100000000000000000010000001000000000000000000010000000000100000000101000000000000000000000010000000000000000100000000000000001000000000010100000
            0010000000000000000000000000100000000000001000000000010000000000000010000000000000000001000000000000000001010000000000000010000001000010000000000000000000000001000000010000000000000000000000100000000001100000
            0000010000000000000000000000001000000000100000000100000000000000010000000000000000100000001000000000000000000000000000000010000100000000100000000100000000001000000000100000000000000001000000000000010000010000
            0000000000100000000000001000000000001000000000010000000000000000000000100000000000000000000000100001000000000000001000100000000000000100000000010000000000010000000000010000000000000000100000000001000000010000
            0000000000000010000000100000000010000000000000000000000010000000000010000000000000000010000000000000000010000001000000010000000000100000000000000000000101000000000000000010000000000000010000000000001000010000
            0000000010000000000000000010000000100000000000000001000000000000000000010000010000000000000010000000000000000100000000000000010000000000001000000000010000000001000000000000100000000010000000000000100000010000
            0100000000000000000000000100000000000000100000000000000000001000000000000000000001000010000000000000010000001000000000000000000001000001000000000000010000000000000000000000000100000000000000000101000010001000
            0001000000000000000000001000000000010000000000000000000001000000000001000000010000000000000000010000000000000000000000000001000000000000010000000000000001000000001000000001000000000000000100100000010000001000
            0000000010000000100000000000000000000000001000000000100000000000000000000000100000000000000100000001000000000000010100000000000000000000000000000000000000001000000000001000001000000000000011000000001000001000
            0000000000010000001000000000000000000000000001000000000010000000010000000000000010000000000000000000000100000000100000000100000000010000000000010000000000000000010000000000000000000000000000001000100001001000
            0000000001000000000000000010000100000000000000000000000000010000000000000000001000001000000000000000000100000000001000000000000001000000010000000101000000000000000001000000000000000000010001000000000000000100
            0000000000100000000000010000000000000000000010001000000000000001000000000000000001000000000000000000100000000000010000000100000000000000001000100000000100000000000000000000000000100001000000100000000000000100
            0000001000000000000000000000010000000100000000000100000000000000000000010010000000000000000100000000000000000001000000000000000000000000000000000000001000010000000000000000010000001000000100000100000001000100
            0000000000000001000001000000000010000000000000000010000000000000000001000000000000000000000000100100000000000000000000000000000000000000100000001000000000000001000000000100000000000100000010001000000010000100
            0000000000001000010000000000000000000000000001000000000100000000000100000000000000000000000010000000001000000001000000000011000000000100000000100000000000000000000001001000000000000000000000000000000010000010
            0000100000000000000000000001000000000000010000000000000000001000000000100000000100000000100000000000000000000100000100000000000000100000100000000001000000000000000000000001000000100000000000000000000001000010
            0001000000000000000000000000100000000000000100000000001000000000001000000000000010000000000000000000000010001000000000100000000100000000001000001000000000000000000100000000010000000000000001000000000000000010
            0000000000000100100000000000000000000010000000000000000000100000000000000000000000100000010000000000010000000000001000010000010000010000000000000000001000000000000000000100000010000000000000100000000000000010
            0000010000000000000000000001000000000000000010000000000001000000000000001001000000000000000100000000000010000000000000001000000000010000000001000010000000000001000001000000000000000000000000000001000000000001
            0000000000010000000000000000010000000000000100000001000000000000000000100000000001000100000000000000000001000010000000000001000000000000000000000100000010000010000000000100000000000000000000000000001000000001
            0000000000001000000000100000000000000000001000000000000000010000000001000000000000100000000001001000000000001000000000000000000010000000000010000000100000010000000000000000000000100000000000000000100000000001
            0000000000000001000000000100000000001000000000000000000000100010000000000000000000010000000010000000000100000000000100000000000000000010000000000000000100100100000000000000010000000000000000000000010000000001
            1000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000100000000000000000000000000000000100000000000000000000100000000000000000010000001000010010000100111111
            """;

    @Test
    public void testParamodification() {
        int b = 208;
        int v = 65;
        int k = 5;
        int r = (v - 1) / (k - 1);
        boolean[][] incidence = new boolean[b][v];
        String[] inc = INCIDENCE.lines().toArray(String[]::new);
        for (int i = 0; i < inc.length; i++) {
            String l = inc[i];
            for (int j = 0; j < l.length(); j++) {
                incidence[j][i] = l.charAt(j) == '1';
            }
        }
        List<Liner> para = paraModifications(incidence, b, v, k, r);
        System.out.println(para.size());
    }

    public static List<Liner> paraModifications(boolean[][] incidence, int b, int v, int k, int r) {
        Liner lnr = Liner.byIncidence(incidence);
        GraphData gd = JNauty.instance().automorphisms(lnr);
        FixBS orbLines = new FixBS(b);
        for (int i = v; i < b + v; i++) {
            orbLines.set(gd.orbits()[i] - v);
        }
        List<Liner> unique = new ArrayList<>();
        for (int ln = orbLines.nextSetBit(0); ln >= 0; ln = orbLines.nextSetBit(ln + 1)) {
            int[] line = lnr.line(ln);
            int[] vert = new int[k * (r - 1)];
            int cnt = 0;
            for (int i = 0; i < b; i++) {
                if (lnr.intersection(ln, i) >= 0) {
                    vert[cnt++] = i;
                }
            }
            Graph g = new Graph(vert.length);
            for (int i = 0; i < vert.length; i++) {
                for (int j = i + 1; j < vert.length; j++) {
                    int inter = lnr.intersection(vert[i], vert[j]);
                    if (inter < 0 || lnr.flag(ln, inter)) {
                        g.connect(i, j);
                    }
                }
            }
            List<FixBS> cList = new ArrayList<>();
            g.bronKerbPivot(clq -> {
                if (clq.cardinality() == r - 1) {
                    cList.add(clq);
                }
            });
            int ncl = cList.size();
            int[][] cl = cList.stream().map(FixBS::toArray).toArray(int[][]::new);
            Graph g1 = new Graph(ncl);
            for (int i = 0; i < ncl; i++) {
                for (int j = i + 1; j < ncl; j++) {
                    if (!cList.get(i).intersects(cList.get(j))) {
                        g1.connect(i, j);
                    }
                }
            }
            List<FixBS> pList = new ArrayList<>();
            g1.bronKerbPivot(clq -> {
                if (clq.cardinality() == k) {
                    pList.add(clq);
                }
            });
            for (FixBS p : pList) {
                int[] part = p.toArray();
                boolean[][] altInc = Arrays.stream(incidence).map(boolean[]::clone).toArray(boolean[][]::new);
                for (int i = 0; i < b; i++) {
                    for (int j = 0; j < k; j++) {
                        altInc[i][line[j]] = false;
                    }
                }
                for (int i = 0; i < k; i++) {
                    altInc[ln][line[i]] = true;
                    for (int j = 0; j < r - 1; j++) {
                        altInc[vert[cl[part[i]][j]]][line[i]] = true;
                    }
                }
                Liner altLnr = Liner.byIncidence(altInc);
                unique.add(altLnr);
            }
        }
        return unique;
    }

    @Test
    public void testBronKerbosh() {
        for (int n = 4; n < 10; n++) {
            Graph g = new Graph(n);
            for (int i = 0; i < n; i++) {
                for (int j = i + 1; j < n; j++) {
                    g.connect(i, j);
                }
            }
            List<FixBS> lst = new ArrayList<>();
            g.bronKerbPivot(lst::add);
            assertEquals(List.of(FixBS.of(n, IntStream.range(0, n).toArray())), lst);
            Graph g1 = new Graph(n);
            for (int i = 0; i < n; i++) {
                g1.connect(i, (i + 1) % n);
            }
            lst.clear();
            g1.bronKerbPivot(lst::add);
            assertEquals(n, lst.size());
        }
        FixBS[] arr = new FixBS[] {
                FixBS.of(12, 1, 2, 3),
                FixBS.of(12, 0, 2, 3, 4),
                FixBS.of(12, 0, 1, 3, 4),
                FixBS.of(12, 0, 1, 2, 5),
                FixBS.of(12, 1, 2, 6),
                FixBS.of(12, 3, 6, 7),
                FixBS.of(12, 4, 5, 7, 8),
                FixBS.of(12, 5, 6, 8),
                FixBS.of(12, 6, 7, 9),
                FixBS.of(12, 8, 10, 11),
                FixBS.of(12, 9, 11),
                FixBS.of(12, 9, 10),
        };
        Graph g = new Graph(arr);
        List<FixBS> lst = new ArrayList<>();
        g.bronKerbPivot(lst::add);
        System.out.println(lst);

        Graph g2 = new Graph(6);
        g2.connect(0, 1);
        g2.connect(0, 4);
        g2.connect(1, 4);
        g2.connect(1, 2);
        g2.connect(3, 4);
        g2.connect(2, 3);
        g2.connect(3, 5);
        g2.bronKerb(a -> System.out.println(Arrays.toString(a.toArray())));
        System.out.println();

        g2.bronKerbPivot(a -> System.out.println(Arrays.toString(a.toArray())));
        System.out.println();
    }

    @Test
    public void testLiner() throws IOException {
        ObjectMapper om = new ObjectMapper();
        int[][] lns = om.readValue(Files.readString(Path.of("/home/ihromant/workspace/math-utils/src/test/resources/a.txt")), int[][].class);
        Liner lnr = new Liner(lns);
        int v = lnr.pointCount();
        int b = lnr.lineCount();
        int k = lnr.line(0).length;
        int r = (v - 1) / (k - 1);
        boolean[][] incidence = new boolean[b][v];
        for (int i = 0; i < b; i++) {
            for (int j = 0; j < v; j++) {
                incidence[i][j] = lnr.flag(i, j);
            }
        }
        List<Liner> unique = paraModifications(incidence, b, v, k, r);
        System.out.println(unique.size());
    }
}
